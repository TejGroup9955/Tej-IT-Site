{% extends 'base.html' %}
{% block content %}
<div class="page-header">
    <h1><i class="fas fa-users me-3"></i>User Details</h1>
    <nav class="breadcrumb">
        <span class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Dashboard</a></span>
        <span class="breadcrumb-item active">User Details</span>
    </nav>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4><i class="fas fa-users me-2"></i>User Details List</h4>
        <button id="exportExcel" class="btn btn-success export-btn">
            <i class="fas fa-file-excel me-1"></i>Export to Excel
        </button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="userDetailsTable" class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Session ID</th>
                        <th>User Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Created At</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.session_id }}</td>
                        <td>{{ user.user_name or 'N/A' }}</td>
                        <td>{{ user.user_email or 'N/A' }}</td>
                        <td>{{ user.user_phone or 'N/A' }}</td>
                        <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') if user.created_at else 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- DataTables Buttons CSS -->
<link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
<!-- DataTables Buttons JS -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

<script>
    // Check if jQuery is loaded
    if (typeof jQuery === 'undefined') {
        console.error('jQuery is not loaded. Please ensure jQuery is included before this script.');
    } else {
        jQuery(document).ready(function($) {
            $('#userDetailsTable').DataTable({
                responsive: true,
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                order: [[5, 'desc']], // Sort by Created At (newest first)
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                     '<"row"<"col-sm-12"t>>' +
                     '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: '<i class="fas fa-file-excel"></i> Export to Excel',
                        className: 'btn btn-success export-btn d-none', // Hidden, triggered by custom button
                        title: 'User_Details_Export',
                        exportOptions: {
                            columns: ':visible'
                        }
                    }
                ],
                language: {
                    search: "_INPUT_",
                    searchPlaceholder: "Search users..."
                },
                columnDefs: [
                    { width: "10%", targets: 0 }, // ID
                    { width: "20%", targets: 1 }, // Session ID
                    { width: "20%", targets: 2 }, // User Name
                    { width: "20%", targets: 3 }, // Email
                    { width: "15%", targets: 4 }, // Phone
                    { width: "15%", targets: 5 }  // Created At
                ]
            });

            // Trigger Excel export when custom button is clicked
            $('#exportExcel').on('click', function() {
                $('#userDetailsTable').DataTable().button('.buttons-excel').trigger();
            });
        });
    }
</script>
{% endblock %}