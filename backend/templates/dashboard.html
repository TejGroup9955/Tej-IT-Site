{% extends 'base.html' %}
{% block content %}
<style>
    .chart-container {
        position: relative;
        width: 100%;
        min-height: 300px;
        padding: 15px;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    .card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .card-header {
        background: linear-gradient(135deg, #f5f7fa, #e4e7eb);
        border-bottom: none;
        padding: 15px 20px;
    }
    .card-body {
        padding: 20px;
    }
    canvas {
        max-width: 100% !important;
        height: auto !important;
    }
</style>

<div class="page-header">
    <h1 class="fs-4"><i class="fas fa-tachometer-alt me-2"></i>Dashboard Overview</h1>
    <nav class="breadcrumb">
        <span class="breadcrumb-item active">Dashboard</span>
    </nav>
</div>

<!-- Quick Stats Widgets -->
<div class="row mb-3">
    <div class="col-lg-3 col-md-6 mb-2">
        <a href="{{ url_for('admin_jobs') }}" class="widget-card">
            <div class="widget-icon"><i class="fas fa-briefcase"></i></div>
            <div class="widget-number">{{ job_count }}</div>
            <div class="widget-label">Total Jobs</div>
        </a>
    </div>
    <div class="col-lg-3 col-md-6 mb-2">
        <a href="{{ url_for('admin_departments') }}" class="widget-card secondary">
            <div class="widget-icon"><i class="fas fa-building"></i></div>
            <div class="widget-number">{{ department_count }}</div>
            <div class="widget-label">Active Departments</div>
        </a>
    </div>
    <div class="col-lg-3 col-md-6 mb-2">
        <a href="{{ url_for('admin_applications') }}" class="widget-card warning">
            <div class="widget-icon"><i class="fas fa-file-alt"></i></div>
            <div class="widget-number">{{ application_count }}</div>
            <div class="widget-label">New Applications Today</div>
        </a>
    </div>
    <div class="col-lg-3 col-md-6 mb-2">
        <a href="{{ url_for('admin_employee_testimonials') }}" class="widget-card info">
            <div class="widget-icon"><i class="fas fa-star"></i></div>
            <div class="widget-number">{{ testimonial_count }}</div>
            <div class="widget-label">Testimonials Count</div>
        </a>
    </div>
</div>

<div class="row mb-3">
    <div class="col-lg-3 col-md-6 mb-2">
        <a href="{{ url_for('admin_teams') }}" class="widget-card success">
            <div class="widget-icon"><i class="fas fa-users"></i></div>
            <div class="widget-number">{{ team_count }}</div>
            <div class="widget-label">Teams Count</div>
        </a>
    </div>
    <div class="col-lg-3 col-md-6 mb-2">
        <a href="{{ url_for('admin_enquiries') }}" class="widget-card danger">
            <div class="widget-icon"><i class="fas fa-envelope"></i></div>
            <div class="widget-number">{{ enquiry_count }}</div>
            <div class="widget-label">New Enquiries</div>
        </a>
    </div>
    <div class="col-lg-3 col-md-6 mb-2">
        <a href="{{ url_for('admin_chats') }}" class="widget-card primary">
            <div class="widget-icon"><i class="fas fa-comments"></i></div>
            <div class="widget-number">{{ chat_count }}</div>
            <div class="widget-label">Chat Sessions</div>
        </a>
    </div>
    <div class="col-lg-3 col-md-6 mb-2">
        <div class="stat-card">
            <div class="stat-number">{{ visit_count|default(0) }}</div>
            <div class="stat-label">Total Page Views</div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-lg-3 col-md-6 mb-2">
        <div class="stat-card">
            <div class="stat-number">{{ unique_visitors|default(0) }}</div>
            <div class="stat-label">Unique Visitors</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-2">
        <div class="stat-card">
            <div class="stat-number">{{ blog_count|default(0) }}</div>
            <div class="stat-label">Published Blogs</div>
        </div>
    </div>
</div>

<!-- Visit Analytics Chart -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="fs-5 mb-0"><i class="fas fa-chart-line me-1"></i>Visit Analytics</h4>
                <form method="GET" class="d-flex">
                    <select name="months" class="form-control form-control-sm me-2" style="max-width: 150px;">
                        <option value="1" {% if filter_months == 1 %}selected{% endif %}>Last 1 Month</option>
                        <option value="2" {% if filter_months == 2 %}selected{% endif %}>Last 2 Months</option>
                        <option value="3" {% if filter_months == 3 %}selected{% endif %}>Last 3 Months</option>
                        <option value="6" {% if filter_months == 6 %}selected{% endif %}>Last 6 Months</option>
                        <option value="12" {% if filter_months == 12 %}selected{% endif %}>Last 12 Months</option>
                    </select>
                    <button type="submit" class="btn btn-outline-primary btn-sm">Filter</button>
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary btn-sm ms-1">Clear</a>
                </form>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    {% if monthly_visits and monthly_visits|length > 0 %}
                    <canvas id="visitsChart"></canvas>
                    {% else %}
                    <p class="text-muted text-center">No visit data available for the selected period.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- All Pages Visit Chart -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="fs-5"><i class="fas fa-bar-chart me-1"></i>All Pages by Visit Count</h4>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    {% if top_pages and top_pages|length > 0 %}
                    <canvas id="pagesChart"></canvas>
                    {% else %}
                    <p class="text-muted text-center">No page visit data available.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Visit Analytics Chart (Bar for single month, Line for multiple months)
    const visitsCtx = document.getElementById('visitsChart')?.getContext('2d');
    if (visitsCtx) {
        try {
            const monthlyVisits = [{% for visit in monthly_visits %}{month: '{{ visit.visit_month }}', total: {{ visit.total_visits|default(0) }}, unique: {{ visit.unique_visits|default(0) }}},{% endfor %}];
            if (monthlyVisits.length === 0) {
                console.warn('No data for Visit Analytics chart');
                return;
            }
            const chartType = monthlyVisits.length === 1 ? 'bar' : 'line';
            new Chart(visitsCtx, {
                type: chartType,
                data: {
                    labels: monthlyVisits.map(v => v.month),
                    datasets: [
                        {
                            label: 'Total Visits',
                            data: monthlyVisits.map(v => v.total),
                            backgroundColor: chartType === 'bar' ? 'rgba(59, 130, 246, 0.7)' : (ctx) => {
                                const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 300);
                                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
                                gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                                return gradient;
                            },
                            borderColor: '#3B82F6',
                            fill: chartType === 'line',
                            tension: chartType === 'line' ? 0.4 : 0,
                            pointRadius: chartType === 'line' ? 5 : 0,
                            pointHoverRadius: chartType === 'line' ? 8 : 0,
                            pointBackgroundColor: '#3B82F6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: chartType === 'line' ? 2 : 0,
                            borderWidth: chartType === 'bar' ? 1 : 2,
                            borderRadius: chartType === 'bar' ? 6 : 0,
                            barThickness: chartType === 'bar' ? 40 : undefined
                        },
                        {
                            label: 'Unique Visitors',
                            data: monthlyVisits.map(v => v.unique),
                            backgroundColor: chartType === 'bar' ? 'rgba(16, 185, 129, 0.7)' : (ctx) => {
                                const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 300);
                                gradient.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
                                gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');
                                return gradient;
                            },
                            borderColor: '#10B981',
                            fill: chartType === 'line',
                            tension: chartType === 'line' ? 0.4 : 0,
                            pointRadius: chartType === 'line' ? 5 : 0,
                            pointHoverRadius: chartType === 'line' ? 8 : 0,
                            pointBackgroundColor: '#10B981',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: chartType === 'line' ? 2 : 0,
                            borderWidth: chartType === 'bar' ? 1 : 2,
                            borderRadius: chartType === 'bar' ? 6 : 0,
                            barThickness: chartType === 'bar' ? 40 : undefined
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.85)',
                            titleFont: { size: 14, family: 'Helvetica, Arial, sans-serif' },
                            bodyFont: { size: 12, family: 'Helvetica, Arial, sans-serif' },
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}`;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 13, family: 'Helvetica, Arial, sans-serif' },
                                padding: 20,
                                usePointStyle: chartType === 'line',
                                boxWidth: chartType === 'line' ? 10 : 15,
                                boxHeight: chartType === 'bar' ? 10 : undefined
                            }
                        },
                        title: {
                            display: true,
                            text: 'Website Visit Trends',
                            font: { size: 18, family: 'Helvetica, Arial, sans-serif', weight: '600' },
                            padding: { top: 10, bottom: 20 },
                            color: '#1F2937'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(209, 213, 219, 0.3)', borderDash: [5, 5] },
                            title: {
                                display: true,
                                text: 'Number of Visits',
                                font: { size: 13, family: 'Helvetica, Arial, sans-serif' },
                                color: '#1F2937'
                            },
                            ticks: {
                                font: { size: 12, family: 'Helvetica, Arial, sans-serif' },
                                color: '#4B5563',
                                padding: 10
                            }
                        },
                        x: {
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Month',
                                font: { size: 13, family: 'Helvetica, Arial, sans-serif' },
                                color: '#1F2937'
                            },
                            ticks: {
                                font: { size: 12, family: 'Helvetica, Arial, sans-serif' },
                                color: '#4B5563',
                                maxRotation: chartType === 'line' ? 45 : 0,
                                minRotation: chartType === 'line' ? 45 : 0
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeOutQuart'
                    }
                }
            });
        } catch (error) {
            console.error('Error rendering Visit Analytics chart:', error);
        }
    } else {
        console.warn('Visit Analytics canvas not found');
    }

    // All Pages Visit Chart (Vertical Bar)
    const pagesCtx = document.getElementById('pagesChart')?.getContext('2d');
    if (pagesCtx) {
        try {
            const allPages = [{% for page in top_pages %}{page: '{{ page.page|default('Unknown')|capitalize }}', count: {{ page.count }}},{% endfor %}]
                .filter(p => p.page && p.page.trim() !== '');
            if (allPages.length === 0) {
                console.warn('No valid data for All Pages chart');
                return;
            }
            console.log('All Pages Data:', allPages); // Debug: Log the data
            // Generate enough colors for all pages
            const colors = [
                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                '#EC4899', '#F97316', '#22D3EE', '#6EE7B7', '#D1D5DB'
            ];
            const backgroundColors = allPages.map((_, i) => colors[i % colors.length]);
            const borderColors = backgroundColors.map(c => c.replace('0.7', '1'));
            new Chart(pagesCtx, {
                type: 'bar',
                data: {
                    labels: allPages.map(p => p.page),
                    datasets: [
                        {
                            label: 'Page Visits',
                            data: allPages.map(p => p.count),
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1,
                            borderRadius: 6,
                            barPercentage: 0.8,
                            categoryPercentage: 0.9
                        }
                    ]
                },
                options: {
                    indexAxis: 'x', // Vertical bars
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.85)',
                            titleFont: { size: 14, family: 'Helvetica, Arial, sans-serif' },
                            bodyFont: { size: 12, family: 'Helvetica, Arial, sans-serif' },
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.y} visits`;
                                }
                            }
                        },
                        legend: {
                            display: false // Single dataset
                        },
                        title: {
                            display: true,
                            text: 'All Pages by Visit Count',
                            font: { size: 18, family: 'Helvetica, Arial, sans-serif', weight: '600' },
                            padding: { top: 10, bottom: 20 },
                            color: '#1F2937'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(209, 213, 219, 0.3)', borderDash: [5, 5] },
                            title: {
                                display: true,
                                text: 'Number of Visits',
                                font: { size: 13, family: 'Helvetica, Arial, sans-serif' },
                                color: '#1F2937'
                            },
                            ticks: {
                                font: { size: 12, family: 'Helvetica, Arial, sans-serif' },
                                color: '#4B5563',
                                padding: 10
                            }
                        },
                        x: {
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Pages',
                                font: { size: 13, family: 'Helvetica, Arial, sans-serif' },
                                color: '#1F2937'
                            },
                            ticks: {
                                font: { size: 12, family: 'Helvetica, Arial, sans-serif' },
                                color: '#4B5563',
                                padding: 10,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeOutQuart'
                    }
                }
            });
        } catch (error) {
            console.error('Error rendering All Pages chart:', error);
        }
    } else {
        console.warn('All Pages canvas not found');
    }
});
</script>
{% endblock %}